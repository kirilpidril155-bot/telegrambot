<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini App ‚Äî –ú–∞–≥–∞–∑–∏–Ω</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<style>
  :root{--accent:#0088cc;--bg:#f5f5f5;--card:#fff;--muted:#666}
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);padding-bottom:80px}
  .container{padding:16px;max-width:980px;margin:0 auto}
  .page{display:none}
  .page.active{display:block}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .city-card{background:var(--card);padding:14px;border-radius:10px;text-align:center;font-weight:700;color:#fff;background:var(--accent);cursor:pointer;border:0}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .current-city{font-weight:700;color:var(--accent)}
  .change-city{background:#eee;border:0;padding:6px 10px;border-radius:8px;cursor:pointer}
  .category{background:var(--card);border-radius:10px;padding:8px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
  .category-head{display:flex;justify-content:space-between;align-items:center;padding:8px 6px;cursor:pointer}
  .category-body{display:none;padding:8px 6px}
  .item-row{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px}
  .thumb{width:80px;height:80px;border-radius:8px;object-fit:cover;background:#eee;border:1px solid rgba(0,0,0,0.03);flex-shrink:0}
  .item-meta{flex:1;min-width:0}
  .item-title{font-weight:700;word-break:break-word}
  .selector{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .step-btn{width:36px;height:36px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:800;cursor:pointer;flex-shrink:0}
  .qty-display{min-width:48px;text-align:center;font-weight:800;flex-shrink:0}
  .add-btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;flex-shrink:0;white-space:nowrap}
  .in-cart{background:#2ea44f}
  .cart-float{position:fixed;left:12px;right:12px;bottom:72px;background:var(--card);padding:10px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 8px 30px rgba(0,0,0,0.12);z-index:200}
  .cart-float.hidden{display:none}
  .cart-list{margin:8px 0}
  .cart-item{display:flex;gap:12px;align-items:center;background:var(--card);padding:10px;border-radius:8px;margin-bottom:8px}
  .cart-item .meta{flex:1;min-width:0}
  .cart-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.danger{background:#e74c3c;color:#fff}
  .btn.success{background:#2ea44f;color:#fff}
  .small{font-size:13px;color:var(--muted)}
  .modal-back{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:400}
  .modal{background:var(--card);padding:16px;border-radius:12px;width:92%;max-width:420px}
  .currency-list{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .currency-card{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer}
  .copy-btn{background:#eee;border:0;padding:8px;border-radius:8px;cursor:pointer;margin-top:8px}
  .network-selector{margin:10px 0}
  .network-buttons{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .network-btn{padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#f9f9f9;cursor:pointer;font-size:12px}
  .network-btn.active{background:var(--accent);color:white;border-color:var(--accent)}
  .payment-method{margin:10px 0}
  .payment-option{padding:10px;border:2px solid #eee;border-radius:8px;margin:8px 0;cursor:pointer}
  .payment-option.active{border-color:var(--accent);background:#f0f8ff}
  .metamask-section{display:none;margin-top:10px}
  .status-waiting{background:#fff3cd;border:1px solid #ffeaa7;padding:10px;border-radius:8px;margin-top:10px;display:none}
  .bottom-nav{position:fixed;left:0;right:0;bottom:0;height:60px;background:#fff;border-top:1px solid #eee;display:flex;align-items:center;justify-content:space-around;z-index:300}
  .nav-item{flex:1;text-align:center;padding-top:6px;cursor:pointer;color:var(--muted)}
  .nav-item.active{color:var(--accent);font-weight:700}
  
  @media (max-width: 480px) {
    .item-row {flex-direction: column; gap: 12px;}
    .thumb {width: 100%; height: 120px; align-self: center;}
    .selector {width: 100%; justify-content: space-between;}
    .add-btn {flex-grow: 1; text-align: center;}
    .cart-actions {flex-direction: column;}
    .cart-actions .btn {width: 100%;}
    .cart-item {flex-direction: column; text-align: center;}
    .cart-item .thumb {width: 100px; height: 100px;}
  }
  @media(min-width:700){.grid{grid-template-columns:repeat(3,1fr)}}
</style>
</head>
<body>
<div class="container">
  <div id="page-home" class="page active">
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏</h2>
    <div class="grid" id="cityGrid"></div>
  </div>

  <div id="page-products" class="page">
    <div class="header">
      <div>
        <div class="current-city" id="selectedCityText">üèô –ì–æ—Ä–æ–¥: ‚Äî</div>
        <div class="small" id="instruction">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏ –≤–∞—Ä–∏–∞–Ω—Ç</div>
      </div>
      <button class="change-city" onclick="goToHome()">üèô –ò–∑–º–µ–Ω–∏—Ç—å –≥–æ—Ä–æ–¥</button>
    </div>
    <div id="categoriesContainer"></div>
  </div>

  <div id="page-cart" class="page">
    <div class="header">
      <div>
        <div style="font-weight:800">–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="small" id="cartCity">–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏: ‚Äî</div>
      </div>
    </div>
    <div id="cartList" class="cart-list"></div>
    <div style="margin-top:10px">
      <div style="font-weight:800">–ò—Ç–æ–≥–æ: <span id="totalGBP">0</span> ¬£</div>
      <div class="small" id="totalConverted"> </div>
      <div class="cart-actions">
        <button class="btn danger" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
        <button class="btn primary" onclick="openPayModal()">–û–ø–ª–∞—Ç–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<div id="cartFloat" class="cart-float hidden">
  <div>
    <div style="font-weight:800">–í –∫–æ—Ä–∑–∏–Ω–µ: <span id="cartCount">0</span> —à—Ç</div>
    <div class="small">–°—É–º–º–∞: <span id="cartSum">0</span> ¬£</div>
  </div>
  <div>
    <button class="btn" onclick="openPage('page-cart')">–û—Ç–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="payModal" style="display:none">
  <div class="modal-back" id="modalBack">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800">–û–ø–ª–∞—Ç–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π</div>
        <button onclick="closePayModal()" style="background:none;border:0;font-size:18px;cursor:pointer">‚úï</button>
      </div>
      
      <div class="payment-method">
        <div class="small">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</div>
        <div class="payment-option active" onclick="selectPaymentMethod('manual')">
          üí≥ –†—É—á–Ω–æ–π –ø–µ—Ä–µ–≤–æ–¥ (–∞–¥—Ä–µ—Å)
        </div>
        <div class="payment-option" onclick="selectPaymentMethod('metamask')">
          ü¶ä MetaMask (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
        </div>
      </div>
      
      <div style="margin-top:10px">
        <div class="small">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –∏ —Å–µ—Ç—å</div>
        <div class="currency-list" id="currencyList"></div>
      </div>
      
      <div class="network-selector">
        <div class="small">–°–µ—Ç—å:</div>
        <div class="network-buttons" id="networkButtons"></div>
      </div>
      
      <div id="manualPayment" style="margin-top:10px">
        <div style="font-weight:800" id="paySummary"></div>
        <div class="small" style="margin-top:6px">–ê–¥—Ä–µ—Å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞:</div>
        <div style="word-break:break-all;margin-top:6px;background:#f7f7f7;padding:8px;border-radius:8px" id="walletAddr"></div>
        <button class="copy-btn" onclick="copyWallet()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å</button>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn primary" onclick="payConfirmManual()">‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª</button>
          <button class="btn" onclick="closePayModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
      
      <div id="metamaskSection" class="metamask-section">
        <div style="font-weight:800" id="metamaskSummary"></div>
        <div style="margin-top:10px">
          <button class="btn success" onclick="connectAndPay()" id="connectMetamaskBtn">
            üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å MetaMask –∏ –æ–ø–ª–∞—Ç–∏—Ç—å
          </button>
        </div>
        <div class="status-waiting" id="waitingStatus">
          ‚è≥ –û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...
        </div>
      </div>
    </div>
  </div>
</div>

<div class="bottom-nav">
  <div class="nav-item active" data-page="page-home" onclick="navTo(this)">–ì–ª–∞–≤–Ω–∞—è</div>
  <div class="nav-item" data-page="page-products" onclick="navTo(this)">–¢–æ–≤–∞—Ä—ã</div>
  <div class="nav-item" data-page="page-cart" onclick="navTo(this)">–ö–æ—Ä–∑–∏–Ω–∞</div>
</div>

<script>
// üî• –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ö–†–ò–ü–¢–û–ü–õ–ê–¢–ï–ñ–ï–ô
const networkConfigs = {
  "USDC": {
    "Ethereum": { address: "–í–ê–®_USDC_ETH_–ö–û–®–ï–õ–ï–ö", chainId: "0x1", decimals: 6, type: "erc20" },
    "Polygon": { address: "–í–ê–®_USDC_POLYGON_–ö–û–®–ï–õ–ï–ö", chainId: "0x89", decimals: 6, type: "erc20" },
    "Arbitrum": { address: "–í–ê–®_USDC_ARBITRUM_–ö–û–®–ï–õ–ï–ö", chainId: "0xa4b1", decimals: 6, type: "erc20" }
  },
  "USDT": {
    "Ethereum": { address: "–í–ê–®_USDT_ETH_–ö–û–®–ï–õ–ï–ö", chainId: "0x1", decimals: 6, type: "erc20" },
    "TRON": { address: "–í–ê–®_TRON_–ö–û–®–ï–õ–ï–ö", chainId: "tron", decimals: 6, type: "tron" },
    "Polygon": { address: "–í–ê–®_USDT_POLYGON_–ö–û–®–ï–õ–ï–ö", chainId: "0x89", decimals: 6, type: "erc20" }
  },
  "ETH": {
    "Ethereum": { address: "–í–ê–®_ETH_–ö–û–®–ï–õ–ï–ö", chainId: "0x1", decimals: 18, type: "native" },
    "Arbitrum": { address: "–í–ê–®_ETH_ARBITRUM_–ö–û–®–ï–õ–ï–ö", chainId: "0xa4b1", decimals: 18, type: "native" }
  },
  "BNB": {
    "BSC": { address: "–í–ê–®_BNB_–ö–û–®–ï–õ–ï–ö", chainId: "0x38", decimals: 18, type: "native" }
  },
  "SOL": {
    "Solana": { address: "–í–ê–®_SOLANA_–ö–û–®–ï–õ–ï–ö", chainId: "solana", decimals: 9, type: "native" }
  }
};

const currencies = {"USDC":1.34,"USDT":1.34,"ETH":0.0003,"BNB":0.0014,"SOL":0.0067};

// üî• –û–°–¢–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï
const submenus = {
  "–¢–æ–≤–∞—Ä 1": ["1.üçç–¶–≤–µ—Çüçç","2.üçí–¶–≤–µ—Çüçí","3.üíÆ–¶–≤–µ—ÇüíÆ","4.üçÉ–¶–≤–µ—ÇüçÉ","5.‚ô•Ô∏è–¶–≤–µ—Ç‚ô•Ô∏è","6.üêò–¶–≤–µ—Çüêò","7.üç´–¶–≤–µ—Çüç´","8.üßÅ–¶–≤–µ—ÇüßÅ"],
  "–¢–æ–≤–∞—Ä 2": ["1.ü••–¶–≤–µ—Çü••","2.üßä–¶–≤–µ—Çüßä","3.‚ùÑÔ∏è–¶–≤–µ—Ç‚ùÑÔ∏è"],
  "–¢–æ–≤–∞—Ä 3": ["1.üíä–¶–≤–µ—Çüíä","2.üçÑ–¶–≤–µ—ÇüçÑ","3.üëΩ–¶–≤–µ—ÇüëΩ"],
  "–¢–æ–≤–∞—Ä 4": ["1.üåà–¶–≤–µ—Çüåà","2.ü•≠–¶–≤–µ—Çü•≠","3.üî•–¶–≤–µ—Çüî•"],
  "–¢–æ–≤–∞—Ä 5": ["1.üçè–¶–≤–µ—Çüçè","2.üçì–¶–≤–µ—Çüçì","3.üå¥–¶–≤–µ—Çüå¥","4.üçì–¶–≤–µ—Çüçì","5.üçã–¶–≤–µ—Çüçã","6.üçá–¶–≤–µ—Çüçá","7.üíú–¶–≤–µ—Çüíú"],
  "–¢–æ–≤–∞—Ä 6": ["1.üç´–¶–≤–µ—Çüç´","2.üéÅ–¶–≤–µ—ÇüéÅ","3.üéÅüéÅ–¶–≤–µ—ÇüéÅüéÅ"]
};

const custom_quantity_prices = {
  "1.üçç–¶–≤–µ—Çüçç": {3.5:40,7:70,14:130}, "2.üçí–¶–≤–µ—Çüçí": {3.5:40,7:70,14:130},
  "3.üíÆ–¶–≤–µ—ÇüíÆ": {3.5:40,7:70,14:130}, "4.üçÉ–¶–≤–µ—ÇüçÉ": {3.5:80,7:150,14:270,28:450},
  "5.‚ô•Ô∏è–¶–≤–µ—Ç‚ô•Ô∏è": {3.5:40,7:70,14:130}, "6.üêò–¶–≤–µ—Çüêò": {3.5:40,7:70,14:130},
  "7.üç´–¶–≤–µ—Çüç´": {3.5:40,7:80,14:120}, "8.üßÅ–¶–≤–µ—ÇüßÅ": {1:70,2:120,3:160},
  "1.ü••–¶–≤–µ—Çü••": {1:70,2:120,3:160}, "2.üßä–¶–≤–µ—Çüßä": {1:17,2:30,4:55,6:90},
  "3.‚ùÑÔ∏è–¶–≤–µ—Ç‚ùÑÔ∏è": {1:25,2:45,3:60,4:80}, "1.üíä–¶–≤–µ—Çüíä": {1:10,2:20,3:25,6:45,12:80},
  "2.üçÑ–¶–≤–µ—ÇüçÑ": {3.5:40,7:70,14:130}, "3.üëΩ–¶–≤–µ—ÇüëΩ": {2.5:320,5:500,7.5:650},
  "1.üåà–¶–≤–µ—Çüåà": {5:30,10:55,15:100,25:170}, "2.ü•≠–¶–≤–µ—Çü•≠": {5:30,10:55,15:100,25:170},
  "3.üî•—Ü–≤–µ—Çüî•": {1:35,2:60,4:100}, "üçè–¶–≤–µ—Çüçè": {5:120}, "üçì—Ü–≤–µ—Çüçì": {5:120},
  "üå¥–¶–≤–µ—Çüå¥": {5:120}, "üçì–¶–≤–µ—Çüçì": {2:80}, "üçã–¶–≤–µ—Çüçã": {2:80}, "üçá–¶–≤–µ—Çüçá": {2:80},
  "üíú–¶–≤–µ—Çüíú": {2:80}, "üç´–¶–≤–µ—Çüç´": {14:90}, "üéÅ–¶–≤–µ—ÇüéÅ": {21:150}, "üéÅüéÅ–¶–≤–µ—ÇüéÅüéÅ": {19:170}
};

const category_images = {
  "–¢–æ–≤–∞—Ä 1":["https://i.postimg.cc/TYSLvKht/IMG-20251001-143808-938.jpg","https://i.postimg.cc/xTqJZvjh/IMG-20251001-143810-989.jpg","https://i.postimg.cc/wTPyY13G/IMG-20251001-143813-440.jpg"],
  "–¢–æ–≤–∞—Ä 2":["https://i.postimg.cc/44YHLvxL/IMG-20251001-143824-749.jpg","https://i.postimg.cc/bY4DKGZ6/IMG-20251001-143827-144.jpg","https://i.postimg.cc/nVNj6sXS/IMG-20251001-143828-170.jpg"],
  "–¢–æ–≤–∞—Ä 3":["https://i.postimg.cc/DfRJtWSx/IMG-20251001-143830-106.jpg","https://i.postimg.cc/Y2TGJ4vy/IMG-20251001-143832-634.jpg","https://i.postimg.cc/c1PgVKKZ/IMG-20251001-143834-526.jpg"],
  "–¢–æ–≤–∞—Ä 4":["https://i.postimg.cc/KvLkFZLy/IMG-20251001-143835-844.jpg","https://i.postimg.cc/8PWJD1WS/IMG-20251001-143837-819.jpg","https://i.postimg.cc/9XsRv44X/IMG-20251001-143840-097.jpg"],
  "–¢–æ–≤–∞—Ä 5":["https://i.postimg.cc/7YqXJQVD/IMG-20251001-133953-876.jpg","https://i.postimg.cc/T3w9CLFk/IMG-20251001-133909-190.jpg"],
  "–¢–æ–≤–∞—Ä 6":["https://i.postimg.cc/yx8PtDWJ/fwgwtwtgwrg.jpg","https://i.postimg.cc/dVY7VzmX/image.png","https://i.postimg.cc/bwJT3DWm/234324.png"]
};

// üî• –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
let selectedCity = null;
let cart = [];
let currentPaymentMethod = 'manual';
let selectedCurrency = null;
let selectedNetwork = null;
const cityList = ["–ú–æ—Å–∫–≤–∞","–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥","–ö–∞–∑–∞–Ω—å","–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥","–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫","–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥","–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É","–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä","–°–∞–º–∞—Ä–∞","–ß–µ–ª—è–±–∏–Ω—Å–∫"];

// üî• –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
const cityGrid = document.getElementById('cityGrid');
cityList.forEach(c=>{
  const b = document.createElement('button');
  b.className='city-card';
  b.textContent = c;
  b.onclick = ()=>selectCity(c);
  cityGrid.appendChild(b);
});

// üî• –ö–†–ò–ü–¢–û–ü–õ–ê–¢–ï–ñ–ò
function selectPaymentMethod(method) {
  currentPaymentMethod = method;
  document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('active'));
  event.target.classList.add('active');
  
  if (method === 'manual') {
    document.getElementById('manualPayment').style.display = 'block';
    document.getElementById('metamaskSection').style.display = 'none';
  } else {
    document.getElementById('manualPayment').style.display = 'none';
    document.getElementById('metamaskSection').style.display = 'block';
    updateMetamaskSummary();
  }
}

function selectCurrency(cur) {
  selectedCurrency = cur;
  updateNetworkButtons(cur);
  updatePaymentSummary();
}

function selectNetwork(network) {
  selectedNetwork = network;
  document.querySelectorAll('.network-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updatePaymentSummary();
}

function updateNetworkButtons(currency) {
  const networkButtons = document.getElementById('networkButtons');
  networkButtons.innerHTML = '';
  
  const networks = networkConfigs[currency];
  if (networks) {
    Object.keys(networks).forEach(network => {
      const btn = document.createElement('button');
      btn.className = 'network-btn';
      btn.textContent = network;
      btn.onclick = () => selectNetwork(network);
      networkButtons.appendChild(btn);
    });
    
    if (Object.keys(networks).length > 0) {
      selectedNetwork = Object.keys(networks)[0];
      networkButtons.firstChild.classList.add('active');
    }
  }
  updatePaymentSummary();
}

function updatePaymentSummary() {
  if (!selectedCurrency || !selectedNetwork) return;
  
  const totalGBP = cart.reduce((s,i)=>s + i.priceGBP * i.count,0);
  const rate = currencies[selectedCurrency] || 1;
  const converted = totalGBP * rate;
  const config = networkConfigs[selectedCurrency][selectedNetwork];
  
  const summary = `${converted.toFixed(6)} ${selectedCurrency} (${totalGBP.toFixed(2)} ¬£)`;
  document.getElementById('paySummary').textContent = summary;
  document.getElementById('walletAddr').textContent = config.address;
  document.getElementById('metamaskSummary').textContent = summary;
}

function updateMetamaskSummary() {
  if (selectedCurrency && selectedNetwork) updatePaymentSummary();
}

// üî• –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –û–ü–õ–ê–¢–´
function openPayModal() {
    console.log("openPayModal called");
    
    if (cart.length === 0) { 
        alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); 
        return; 
    }
    if (!selectedCity) { 
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥'); 
        return; 
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ UI
    const currencyListEl = document.getElementById('currencyList');
    currencyListEl.innerHTML = '';
    
    Object.keys(currencies).forEach(c => {
        const cc = document.createElement('div'); 
        cc.className = 'currency-card'; 
        cc.textContent = c;
        cc.onclick = () => selectCurrency(c);
        currencyListEl.appendChild(cc);
    });
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã –∏ —Å–µ—Ç–∏
    selectedCurrency = null;
    selectedNetwork = null;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
    if (currentPaymentMethod === 'manual') {
        document.getElementById('manualPayment').style.display = 'block';
        document.getElementById('metamaskSection').style.display = 'none';
    } else {
        document.getElementById('manualPayment').style.display = 'none';
        document.getElementById('metamaskSection').style.display = 'block';
    }
    
    document.getElementById('payModal').style.display = 'block';
    
    // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –≤–∞–ª—é—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (Object.keys(currencies).length > 0) {
        selectedCurrency = Object.keys(currencies)[0];
        updateNetworkButtons(selectedCurrency);
    }
}

function closePayModal() { 
    document.getElementById('payModal').style.display = 'none'; 
}

// üî• META MASK –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø
async function connectAndPay() {
    if (!selectedCurrency || !selectedNetwork) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –∏ —Å–µ—Ç—å');
        return;
    }

    if (typeof window.ethereum === 'undefined') {
        alert('MetaMask –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –ø–µ—Ä–µ–≤–æ–¥.');
        return;
    }

    const connectBtn = document.getElementById('connectMetamaskBtn');
    connectBtn.textContent = 'üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...';
    connectBtn.disabled = true;

    try {
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ MetaMask
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        const web3 = new Web3(window.ethereum);
        const accounts = await web3.eth.getAccounts();
        const userAddress = accounts[0];

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–µ—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        const targetChainId = networkConfigs[selectedCurrency][selectedNetwork].chainId;
        await switchNetwork(targetChainId);

        const totalGBP = cart.reduce((s,i)=>s + i.priceGBP * i.count,0);
        const amount = totalGBP * currencies[selectedCurrency];
        const config = networkConfigs[selectedCurrency][selectedNetwork];

        let txHash;
        
        if (config.type === 'native') {
            // –ù–∞—Ç–∏–≤–Ω–∞—è –≤–∞–ª—é—Ç–∞ (ETH, BNB)
            txHash = await sendNativeToken(web3, userAddress, config.address, amount, config.decimals);
        } else if (config.type === 'erc20') {
            // ERC-20 —Ç–æ–∫–µ–Ω—ã (USDC, USDT)
            txHash = await sendERC20Token(web3, userAddress, config.address, amount, config.decimals);
        }

        if (txHash) {
            document.getElementById('waitingStatus').style.display = 'block';
            connectBtn.style.display = 'none';
            
            // üî• –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞
            await sendOrderToBot(txHash, 'metamask');
            
            // –ó–ê–ö–†–´–í–ê–ï–ú MINI APP –ü–û–°–õ–ï –û–¢–ü–†–ê–í–ö–ò
            Telegram.WebApp.close();
        }

    } catch (error) {
        console.error('Payment error:', error);
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        if (error.code === 4001) {
            alert('–í—ã –æ—Ç–º–µ–Ω–∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ MetaMask');
        } else if (error.message.includes('insufficient funds')) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ');
        } else {
            alert('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ' + error.message);
        }
        
        connectBtn.textContent = 'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å MetaMask –∏ –æ–ø–ª–∞—Ç–∏—Ç—å';
        connectBtn.disabled = false;
    }
}

async function switchNetwork(chainId) {
    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: chainId }],
        });
    } catch (switchError) {
        if (switchError.code === 4902) {
            // –°–µ—Ç—å –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
            const networkParams = getNetworkParams(chainId);
            if (networkParams) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [networkParams],
                });
            }
        }
    }
}

function getNetworkParams(chainId) {
    const networks = {
        '0x89': { // Polygon
            chainId: '0x89',
            chainName: 'Polygon Mainnet',
            rpcUrls: ['https://polygon-rpc.com/'],
            blockExplorerUrls: ['https://polygonscan.com/'],
            nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 }
        },
        '0x38': { // BSC
            chainId: '0x38',
            chainName: 'Binance Smart Chain',
            rpcUrls: ['https://bsc-dataseed.binance.org/'],
            blockExplorerUrls: ['https://bscscan.com/'],
            nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 }
        },
        '0xa4b1': { // Arbitrum
            chainId: '0xa4b1',
            chainName: 'Arbitrum One',
            rpcUrls: ['https://arb1.arbitrum.io/rpc'],
            blockExplorerUrls: ['https://arbiscan.io/'],
            nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 }
        }
    };
    return networks[chainId];
}

async function sendNativeToken(web3, from, to, amount, decimals) {
    const amountWei = web3.utils.toWei(amount.toString(), 'ether');
    
    const tx = {
        from: from,
        to: to,
        value: amountWei,
        gas: 21000
    };
    
    const txHash = await web3.eth.sendTransaction(tx);
    return txHash.transactionHash;
}

async function sendERC20Token(web3, from, to, amount, decimals) {
    const tokenAddress = networkConfigs[selectedCurrency][selectedNetwork].address;
    const amountWei = web3.utils.toWei(amount.toString(), decimals === 6 ? 'mwei' : 'ether');
    
    const abi = [{
        "constant": false,
        "inputs": [
            {"name": "_to", "type": "address"},
            {"name": "_value", "type": "uint256"}
        ],
        "name": "transfer",
        "outputs": [{"name": "", "type": "bool"}],
        "type": "function"
    }];
    
    const contract = new web3.eth.Contract(abi, tokenAddress);
    const data = contract.methods.transfer(to, amountWei).encodeABI();
    
    const tx = {
        from: from,
        to: tokenAddress,
        data: data,
        gas: 100000
    };
    
    const txHash = await web3.eth.sendTransaction(tx);
    return txHash.transactionHash;
}

// üî• –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –í –ë–û–¢ –î–õ–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ô –ü–†–û–í–ï–†–ö–ò
async function sendOrderToBot(txHash = null, paymentMethod) {
    const orderData = {
        city: selectedCity,
        currency: selectedCurrency,
        network: selectedNetwork,
        totalGBP: cart.reduce((s,i)=>s + i.priceGBP * i.count,0).toFixed(2),
        totalConverted: (cart.reduce((s,i)=>s + i.priceGBP * i.count,0) * currencies[selectedCurrency]).toFixed(6),
        wallet: networkConfigs[selectedCurrency][selectedNetwork].address,
        items: cart.map(item => ({
            product: item.product,
            color: item.color,
            qty: item.qty,
            priceGBP: item.priceGBP,
            count: item.count
        })),
        user_id: Telegram.WebApp.initDataUnsafe.user?.id,
        first_name: Telegram.WebApp.initDataUnsafe.user?.first_name,
        timestamp: new Date().toISOString(),
        payment_method: paymentMethod,
        tx_hash: txHash
    };

    console.log("üì¶ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –≤ –±–æ—Ç:", orderData);
    
    // üî• –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –í –ë–û–¢ –ß–ï–†–ï–ó TELEGRAM WEB APP
    Telegram.WebApp.sendData(JSON.stringify(orderData));
}

// üî• –†–£–ß–ù–û–ô –ü–ï–†–ï–í–û–î - –ó–ê–ö–†–´–¢–ò–ï APP –ü–†–ò –ù–ê–ñ–ê–¢–ò–ò "–Ø –û–ü–õ–ê–¢–ò–õ"
function payConfirmManual() {
    if (!selectedCurrency || !selectedNetwork) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –∏ —Å–µ—Ç—å');
        return;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –±–µ–∑ tx_hash –¥–ª—è —Ä—É—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã
    sendOrderToBot(null, 'manual');
    
    // –ó–ê–ö–†–´–í–ê–ï–ú MINI APP –°–†–ê–ó–£ –ü–û–°–õ–ï –ù–ê–ñ–ê–¢–ò–Ø "–Ø –û–ü–õ–ê–¢–ò–õ"
    Telegram.WebApp.close();
}

function copyWallet(){
    const addr = document.getElementById('walletAddr').textContent;
    if (!addr) return;
    navigator.clipboard?.writeText(addr).then(()=>{ 
        alert('–ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä') 
    }).catch(()=>{ 
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é') 
    });
}

// üî• –û–°–¢–ê–í–®–ò–ï–°–Ø –§–£–ù–ö–¶–ò–ò –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
function navTo(element){
    const page = element.dataset.page;
    openPage(page);
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    element.classList.add('active');
}

function openPage(id){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    const cartFloat = document.getElementById('cartFloat');
    if (id === 'page-cart') {
        cartFloat.classList.add('hidden');
    } else if (cart.length > 0) {
        cartFloat.classList.remove('hidden');
    }
    if (id==='page-products') renderCategories();
    if (id==='page-cart') renderCart();
}

function selectCity(city){
    selectedCity = city;
    document.getElementById('selectedCityText').textContent = 'üèô –ì–æ—Ä–æ–¥: ' + city;
    document.getElementById('cartCity').textContent = '–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏: ' + city;
    openPage('page-products');
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelector('.nav-item[data-page="page-products"]').classList.add('active');
    renderCategories();
}

function goToHome(){ 
    openPage('page-home'); 
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); 
    document.querySelector('.nav-item[data-page="page-home"]').classList.add('active'); 
}

function renderCategories(){
    const container = document.getElementById('categoriesContainer');
    container.innerHTML = '';
    Object.keys(submenus).forEach(prod=>{
        const cat = document.createElement('div'); cat.className='category';
        const head = document.createElement('div'); head.className='category-head';
        head.innerHTML = `<div style="font-weight:800">${prod}</div><div class="small">‚ñæ</div>`;
        const body = document.createElement('div'); body.className='category-body';
        
        submenus[prod].forEach(color=>{
            const row = document.createElement('div'); row.className='item-row';
            const img = document.createElement('img'); img.className='thumb'; img.src = (category_images[prod] && category_images[prod][0]) || '';
            img.onerror = function() { this.style.display = 'none'; };
            const meta = document.createElement('div'); meta.className='item-meta';
            meta.innerHTML = `<div class="item-title">${color}</div><div class="small">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É</div>`;
            const sel = document.createElement('div'); sel.className='selector';
            
            const priceKey = findPriceKey(color);
            let grads = priceKey ? Object.keys(custom_quantity_prices[priceKey]).map(x => parseFloat(x)).sort((a,b)=>a-b) : [1];
            let idx = 0;
            
            const minus = document.createElement('button'); minus.className='step-btn'; minus.textContent='‚àí';
            const plus = document.createElement('button'); plus.className='step-btn'; plus.textContent='+';
            const qtyDisplay = document.createElement('div'); qtyDisplay.className='qty-display'; 
            const priceSpan = document.createElement('div'); priceSpan.className='small'; priceSpan.style.marginLeft='8px';
            const addBtn = document.createElement('button'); addBtn.className='add-btn'; addBtn.textContent='–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É';
            
            function updateDisplay(){
                const q = grads[idx];
                qtyDisplay.textContent = (Number.isInteger(q) ? q : q) + ' g';
                const pKey = priceKey;
                const price = pKey ? custom_quantity_prices[pKey][q] : 0;
                priceSpan.textContent = price + ' ¬£';
            }
            
            minus.onclick = (ev)=>{ ev.stopPropagation(); idx = Math.max(0, idx-1); updateDisplay(); };
            plus.onclick = (ev)=>{ ev.stopPropagation(); idx = Math.min(grads.length-1, idx+1); updateDisplay(); };
            
            addBtn.onclick = (ev)=>{
                ev.stopPropagation();
                const q = grads[idx];
                const pKey = priceKey;
                const price = pKey ? custom_quantity_prices[pKey][q] : 0;
                addToCart({product:prod, color:color, qty:q, priceGBP:price});
                const oldText = addBtn.textContent;
                addBtn.textContent = '‚úÖ –í –∫–æ—Ä–∑–∏–Ω–µ';
                addBtn.classList.add('in-cart');
                setTimeout(()=>{ addBtn.textContent = oldText; addBtn.classList.remove('in-cart'); }, 1500);
            };
            
            sel.appendChild(minus); sel.appendChild(qtyDisplay); sel.appendChild(plus); sel.appendChild(priceSpan); sel.appendChild(addBtn);
            updateDisplay();
            row.appendChild(img); row.appendChild(meta); row.appendChild(sel);
            body.appendChild(row);
        });
        
        head.onclick = ()=>{ 
            const open = body.style.display==='block'; 
            document.querySelectorAll('.category-body').forEach(b=>b.style.display='none'); 
            body.style.display = open? 'none' : 'block'; 
        };
        cat.appendChild(head); cat.appendChild(body); container.appendChild(cat);
    });
}

function addToCart(item){
    const idx = cart.findIndex(it => it.product===item.product && it.color===item.color && it.qty===item.qty && it.priceGBP===item.priceGBP);
    if (idx>=0){ cart[idx].count += 1; } else { item.count = 1; cart.push(item); }
    refreshCartFloat();
}

function refreshCartFloat(){
    const count = cart.reduce((s,i)=>s+i.count,0);
    const sum = cart.reduce((s,i)=>s + i.priceGBP * i.count,0);
    document.getElementById('cartCount').textContent = count;
    document.getElementById('cartSum').textContent = sum.toFixed(2);
    const cf = document.getElementById('cartFloat');
    const isCartPage = document.getElementById('page-cart').classList.contains('active');
    cf.classList.toggle('hidden', count===0 || isCartPage);
}

function renderCart(){
    const list = document.getElementById('cartList');
    list.innerHTML = '';
    if (!selectedCity){
        document.getElementById('cartCity').textContent = '–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏: ‚Äî';
    } else {
        document.getElementById('cartCity').textContent = '–ì–æ—Ä–æ–¥ –¥–æ—Å—Ç–∞–≤–∫–∏: ' + selectedCity;
    }
    if (cart.length===0) { 
        list.innerHTML = '<div class="small">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'; 
        document.getElementById('totalGBP').textContent = '0.00'; 
        document.getElementById('totalConverted').textContent = ''; 
        return; 
    }
    cart.forEach((it, idx)=>{
        const el = document.createElement('div'); el.className='cart-item';
        const img = document.createElement('img'); img.className='thumb'; img.src = (category_images[it.product] && category_images[it.product][0]) || '';
        img.onerror = function() { this.style.display = 'none'; };
        const meta = document.createElement('div'); meta.className='meta';
        meta.innerHTML = `<div style="font-weight:800">${it.product}</div><div class="small">${it.color} ‚Ä¢ ${it.qty} g</div><div class="small">–¶–µ–Ω–∞: ${it.priceGBP} ¬£ ‚Ä¢ –ö–æ–ª-–≤–æ: ${it.count}</div>`;
        const controls = document.createElement('div');
        controls.innerHTML = `<div style="text-align:right;font-weight:800">${(it.priceGBP*it.count).toFixed(2)} ¬£</div>
          <div style="margin-top:8px;display:flex;gap:6px;align-items:center;justify-content:flex-end">
            <button class="step-btn" onclick="decCartItem(${idx})">‚àí</button>
            <div style="min-width:24px;text-align:center">${it.count}</div>
            <button class="step-btn" onclick="incCartItem(${idx})">+</button>
            <button class="step-btn" style="background:#cc3333" onclick="removeCartItem(${idx})">‚úï</button>
          </div>`;
        el.appendChild(img); el.appendChild(meta); el.appendChild(controls);
        list.appendChild(el);
    });
    const total = cart.reduce((s,i)=>s + i.priceGBP * i.count,0);
    document.getElementById('totalGBP').textContent = total.toFixed(2);
}

function incCartItem(i){ cart[i].count += 1; renderCart(); refreshCartFloat(); }
function decCartItem(i){ cart[i].count = Math.max(1, cart[i].count - 1); renderCart(); refreshCartFloat(); }
function removeCartItem(i){ cart.splice(i,1); renderCart(); refreshCartFloat(); }
function clearCart(){ cart = []; renderCart(); refreshCartFloat(); }

function normalizeKey(s){ return String(s||'').toLowerCase().replace(/[\s\._]/g,'').normalize('NFKD'); }
function findPriceKey(color){
    if (custom_quantity_prices[color]) return color;
    const norm = normalizeKey(color);
    for (const k of Object.keys(custom_quantity_prices)){
        if (normalizeKey(k) === norm) return k;
    }
    const m = color.match(/^(\d)(.*)/);
    if (m){
        const try1 = m[1]+'.'+m[2];
        if (custom_quantity_prices[try1]) return try1;
    }
    return null;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', ()=>{
    window.Telegram?.WebApp?.ready();
    refreshCartFloat();
});
</script>
</body>
</html>