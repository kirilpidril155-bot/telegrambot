<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GiftShop — Premium Store</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --secondary: #f59e0b;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-card: rgba(30, 41, 59, 0.8);
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #64748b;
    --border: rgba(255, 255, 255, 0.1);
    --shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --gradient-secondary: linear-gradient(135deg, #f59e0b 0%, #eab308 100%);
    --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
    --gradient-card: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    padding-bottom: 80px;
    min-height: 100vh;
  }

  .container {
    padding: 16px;
    max-width: 980px;
    margin: 0 auto;
  }

  .page {
    display: none;
    animation: fadeIn 0.5s ease-in-out;
  }

  .page.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Header Styles */
  .app-header {
    text-align: center;
    margin-bottom: 24px;
    position: relative;
  }

  .app-header h1 {
    font-size: 28px;
    font-weight: 800;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }

  .app-header .subtitle {
    color: var(--text-secondary);
    font-size: 14px;
  }

  /* Card Styles */
  .glass-card {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
  }

  .glass-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
  }

  /* City Grid */
  .city-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 20px;
  }

  @media (min-width: 768px) {
    .city-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .city-card {
    background: var(--gradient-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px 12px;
    text-align: center;
    font-weight: 700;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .city-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s;
  }

  .city-card:hover::before {
    left: 100%;
  }

  .city-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
  }

  /* Category Styles */
  .category {
    background: var(--gradient-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    margin-bottom: 16px;
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .category-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    cursor: pointer;
    background: rgba(99, 102, 241, 0.1);
    transition: background 0.3s ease;
  }

  .category-head:hover {
    background: rgba(99, 102, 241, 0.2);
  }

  .category-title {
    font-weight: 700;
    font-size: 18px;
    color: var(--text-primary);
  }

  .category-arrow {
    color: var(--text-secondary);
    transition: transform 0.3s ease;
  }

  .category.expanded .category-arrow {
    transform: rotate(180deg);
  }

  .category-body {
    display: none;
    padding: 16px;
    background: rgba(15, 23, 42, 0.5);
  }

  .category.expanded .category-body {
    display: block;
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from { opacity: 0; max-height: 0; }
    to { opacity: 1; max-height: 1000px; }
  }

  /* Product Items */
  .product-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: rgba(30, 41, 59, 0.5);
    border-radius: 12px;
    margin-bottom: 12px;
    border: 1px solid transparent;
    transition: all 0.3s ease;
  }

  .product-item:hover {
    border-color: var(--primary);
    transform: translateX(5px);
  }

  .product-image {
    width: 80px;
    height: 80px;
    border-radius: 12px;
    object-fit: cover;
    border: 2px solid var(--border);
    transition: all 0.3s ease;
  }

  .product-item:hover .product-image {
    border-color: var(--primary);
    transform: scale(1.05);
  }

  .product-info {
    flex: 1;
    min-width: 0;
  }

  .product-name {
    font-weight: 700;
    font-size: 16px;
    margin-bottom: 4px;
    color: var(--text-primary);
  }

  .product-description {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 8px;
  }

  /* Selector Styles */
  .selector {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .step-btn {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    border: none;
    background: var(--gradient-primary);
    color: white;
    font-weight: 800;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .step-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
  }

  .qty-display {
    min-width: 48px;
    text-align: center;
    font-weight: 800;
    color: var(--text-primary);
  }

  .price-display {
    color: var(--secondary);
    font-weight: 700;
    margin-left: 8px;
  }

  .add-btn {
    background: var(--gradient-success);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
  }

  .add-btn.in-cart {
    background: var(--gradient-secondary);
  }

  /* Cart Styles */
  .cart-item {
    display: flex;
    gap: 16px;
    align-items: center;
    background: var(--gradient-card);
    padding: 16px;
    border-radius: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
    transition: all 0.3s ease;
  }

  .cart-item:hover {
    border-color: var(--primary);
    transform: translateX(5px);
  }

  .cart-item-image {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    object-fit: cover;
    border: 2px solid var(--border);
  }

  .cart-item-info {
    flex: 1;
  }

  .cart-item-name {
    font-weight: 700;
    margin-bottom: 4px;
  }

  .cart-item-details {
    color: var(--text-secondary);
    font-size: 13px;
  }

  .cart-item-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Floating Cart */
  .cart-float {
    position: fixed;
    left: 16px;
    right: 16px;
    bottom: 80px;
    background: var(--gradient-card);
    backdrop-filter: blur(20px);
    padding: 16px;
    border-radius: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    border: 1px solid var(--border);
    z-index: 1000;
    animation: slideUp 0.3s ease;
  }

  .cart-float.hidden {
    display: none;
  }

  @keyframes slideUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  /* Bottom Navigation */
  .bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 70px;
    background: var(--bg-secondary);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-around;
    z-index: 1000;
    padding: 0 10px;
  }

  .nav-item {
    flex: 1;
    text-align: center;
    padding: 12px 8px;
    cursor: pointer;
    color: var(--text-secondary);
    border-radius: 12px;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 12px;
  }

  .nav-item.active {
    color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
    transform: translateY(-5px);
  }

  .nav-icon {
    font-size: 20px;
  }

  /* Button Styles */
  .btn {
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
  }

  .btn.primary {
    background: var(--gradient-primary);
    color: white;
  }

  .btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
  }

  .btn.secondary {
    background: var(--gradient-secondary);
    color: white;
  }

  .btn.danger {
    background: var(--danger);
    color: white;
  }

  .btn.success {
    background: var(--gradient-success);
    color: white;
  }

  /* Modal Styles */
  .modal-back {
    position: fixed;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    animation: fadeIn 0.3s ease;
  }

  .modal {
    background: var(--gradient-card);
    backdrop-filter: blur(20px);
    padding: 24px;
    border-radius: 24px;
    width: 90%;
    max-width: 400px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* Status Pages */
  .status-page {
    text-align: center;
    padding: 40px 20px;
  }

  .status-icon {
    font-size: 80px;
    margin-bottom: 20px;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .status-title {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 16px;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .status-message {
    color: var(--text-secondary);
    margin-bottom: 30px;
    line-height: 1.6;
  }

  /* Progress Bar */
  .progress-bar {
    width: 100%;
    height: 6px;
    background: var(--bg-secondary);
    border-radius: 3px;
    margin: 24px 0;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 3px;
  }

  /* Live Logs */
  .live-logs {
    margin-top: 20px;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    max-height: 200px;
    overflow-y: auto;
    text-align: left;
    font-family: 'Courier New', monospace;
    font-size: 12px;
  }

  .log-entry {
    margin-bottom: 8px;
    padding: 8px;
    border-radius: 6px;
    background: var(--bg-primary);
  }

  /* Currency Cards */
  .currency-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 16px 0;
  }

  .currency-card {
    background: var(--bg-secondary);
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 12px 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .currency-card.selected {
    border-color: var(--primary);
    background: rgba(99, 102, 241, 0.1);
    transform: scale(1.05);
  }

  .currency-card:hover {
    border-color: var(--primary);
  }

  /* Network Buttons */
  .network-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .network-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .network-btn.active {
    background: var(--gradient-primary);
    color: white;
    border-color: var(--primary);
  }

  /* Confetti */
  .confetti {
    position: fixed;
    width: 12px;
    height: 12px;
    background: var(--primary);
    animation: confettiFall 3s linear forwards;
    z-index: 3000;
  }

  @keyframes confettiFall {
    0% { transform: translateY(-100px) rotate(0deg) scale(1); opacity: 1; }
    100% { transform: translateY(100vh) rotate(360deg) scale(0); opacity: 0; }
  }

  /* Utility Classes */
  .text-center { text-align: center; }
  .text-muted { color: var(--text-muted); }
  .text-success { color: var(--success); }
  .mb-16 { margin-bottom: 16px; }
  .mt-16 { margin-top: 16px; }

  /* Responsive */
  @media (max-width: 480px) {
    .container { padding: 12px; }
    .city-grid { grid-template-columns: 1fr; }
    .product-item { flex-direction: column; text-align: center; }
    .product-image { width: 100%; height: 120px; }
    .selector { justify-content: center; }
    .cart-item { flex-direction: column; text-align: center; }
    .cart-item-image { width: 80px; height: 80px; }
  }
</style>
</head>
<body>
<div class="container">
  <!-- Home Page -->
  <div id="page-home" class="page active">
    <div class="app-header">
      <h1>🎁 GiftShop</h1>
      <div class="subtitle">Premium delivery service</div>
    </div>
    
    <div class="glass-card">
      <h3 class="text-center mb-16">🏙 Выберите город доставки</h3>
      <div class="city-grid" id="cityGrid"></div>
    </div>
  </div>

  <!-- Products Page -->
  <div id="page-products" class="page">
    <div class="app-header">
      <h1>🛍 Товары</h1>
      <div class="subtitle" id="selectedCityText">Город: не выбран</div>
    </div>
    
    <div class="glass-card">
      <button class="btn secondary" onclick="goToHome()" style="width: 100%; margin-bottom: 16px;">
        🏙 Сменить город
      </button>
      <div id="categoriesContainer"></div>
    </div>
  </div>

  <!-- Cart Page -->
  <div id="page-cart" class="page">
    <div class="app-header">
      <h1>🛒 Корзина</h1>
      <div class="subtitle" id="cartCity">Город доставки: не выбран</div>
    </div>
    
    <div class="glass-card">
      <div id="cartList" class="cart-list"></div>
      
      <div class="mt-16">
        <div style="font-size: 24px; font-weight: 800; text-align: center; margin-bottom: 8px;">
          Итого: <span id="totalGBP">0</span> £
        </div>
        <div class="text-muted text-center" id="totalConverted"></div>
        
        <div style="display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap;">
          <button class="btn danger" onclick="clearCart()" style="flex: 1;">
            🗑 Очистить
          </button>
          <button class="btn primary" onclick="openPayModal()" style="flex: 2;">
            💳 Оплатить
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Check Page -->
  <div id="page-payment-check" class="page">
    <div class="status-page">
      <div class="status-icon">⏳</div>
      <div class="status-title">Проверяем платеж</div>
      <div class="status-message" id="paymentStatusMessage">
        Ожидаем поступление средств на кошелек...
      </div>
      
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      
      <div class="live-logs" id="liveLogs">
        <div class="log-entry">
          <span class="log-time" id="currentTime"></span>
          <span class="log-info">🚀 Запуск системы проверки платежей...</span>
        </div>
      </div>
      
      <div style="margin-top: 30px;">
        <button class="btn primary" onclick="checkPaymentStatus()">
          🔄 Проверить снова
        </button>
        <button class="btn secondary" onclick="openPage('page-home')" style="margin-top: 12px;">
          На главную
        </button>
      </div>
    </div>
  </div>

  <!-- Payment Success Page -->
  <div id="page-payment-success" class="page">
    <div class="status-page">
      <div class="status-icon">🎉</div>
      <div class="status-title">Оплата подтверждена!</div>
      <div class="status-message">
        ✅ <strong>Ваш заказ успешно оплачен и принят в обработку!</strong>
      </div>
      
      <div class="glass-card" style="text-align: left;">
        <h3 style="margin-bottom: 16px; color: var(--primary);">Детали заказа</h3>
        <div id="orderItemsList"></div>
        <div style="display: flex; justify-content: space-between; padding: 16px 0; font-weight: 800; font-size: 18px; border-top: 2px solid var(--border); margin-top: 8px;">
          <span>Итого:</span>
          <span id="orderTotalAmount">0 £</span>
        </div>
      </div>
      
      <div class="glass-card" style="text-align: left; margin-top: 16px;">
        <h4 style="margin-bottom: 12px; color: var(--success);">📦 Информация о доставке</h4>
        <div style="margin-bottom: 12px;">
          <strong>🏙 Город доставки:</strong><br>
          <span id="deliveryCity">—</span>
        </div>
        <div style="margin-bottom: 12px;">
          <strong>⏰ Время доставки:</strong><br>
          <span>24 часа с момента подтверждения</span>
        </div>
        <div>
          <strong>🚚 Статус:</strong><br>
          <span style="color: var(--success); font-weight: 800;">✅ Заказ собран и готов к отправке</span>
        </div>
      </div>
      
      <button class="btn success" onclick="openPage('page-home')" style="margin-top: 24px;">
        🏠 На главную
      </button>
    </div>
  </div>
</div>

<!-- Floating Cart -->
<div id="cartFloat" class="cart-float hidden">
  <div>
    <div style="font-weight: 800; font-size: 16px;">В корзине: <span id="cartCount">0</span> шт</div>
    <div class="text-muted">Сумма: <span id="cartSum">0</span> £</div>
  </div>
  <button class="btn primary" onclick="openPage('page-cart')">
    Открыть
  </button>
</div>

<!-- Payment Modal -->
<div id="payModal" style="display: none;">
  <div class="modal-back" id="modalBack">
    <div class="modal">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="font-weight: 800; font-size: 20px;">💳 Оплата</div>
        <button onclick="closePayModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; padding: 4px;">✕</button>
      </div>
      
      <div class="text-muted" style="margin-bottom: 16px;">Выберите валюту и сеть</div>
      
      <div class="currency-grid" id="currencyList"></div>
      
      <div style="margin: 20px 0;">
        <div class="text-muted" style="margin-bottom: 8px;">Сеть:</div>
        <div class="network-buttons" id="networkButtons"></div>
      </div>
      
      <div id="manualPayment">
        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
          <div class="text-muted">Сумма к оплате:</div>
          <div style="font-weight: 800; font-size: 18px;" id="paySummary"></div>
        </div>
        
        <div class="text-muted">Адрес для перевода:</div>
        <div style="word-break: break-all; margin: 8px 0; background: var(--bg-primary); padding: 12px; border-radius: 8px; font-size: 12px; border: 1px solid var(--border);" id="walletAddr"></div>
        
        <button class="btn secondary" onclick="copyWallet()" style="width: 100%; margin-bottom: 12px;">
          📋 Копировать адрес
        </button>
        
        <div style="display: flex; gap: 8px;">
          <button class="btn success" onclick="payConfirmManual()" style="flex: 2;">
            ✅ Я оплатил
          </button>
          <button class="btn" onclick="closePayModal()" style="flex: 1;">
            Закрыть
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <div class="nav-item active" data-page="page-home" onclick="navTo(this)">
    <div class="nav-icon">🏠</div>
    <div>Главная</div>
  </div>
  <div class="nav-item" data-page="page-products" onclick="navTo(this)">
    <div class="nav-icon">🛍</div>
    <div>Товары</div>
  </div>
  <div class="nav-item" data-page="page-cart" onclick="navTo(this)">
    <div class="nav-icon">🛒</div>
    <div>Корзина</div>
  </div>
</div>

<script>
// 🔥 ВАШ СУЩЕСТВУЮЩИЙ JAVASCRIPT КОД ОСТАЕТСЯ БЕЗ ИЗМЕНЕНИЙ
// Все функции и логика полностью сохранены, только добавлены новые стили

// 🔥 КОНФИГУРАЦИЯ
const networkConfigs = {
  "BNB": {
    "Ethereum": { 
      address: "0xF879a1050307C2E7272CF57A9a6AF6088A307d4B", 
      chainId: "0x1", 
      decimals: 18, 
      type: "erc20",
      token_address: "0xB8c77482e45F1F44dE1745F52C74426C631bDD52",
      api_key: "rbCygNlrhGHmZ0DlSfpYO",
      api_url: "https://eth-mainnet.g.alchemy.com/v2"
    }
  },
  "ETH": {
    "Ethereum": { 
      address: "0xF879a1050307C2E7272CF57A9a6AF6088A307d4B", 
      chainId: "0x1", 
      decimals: 18, 
      type: "native",
      api_key: "rbCygNlrhGHmZ0DlSfpYO",
      api_url: "https://eth-mainnet.g.alchemy.com/v2"
    }
  },
  "USDT": {
    "Ethereum": { 
      address: "0xF879a1050307C2E7272CF57A9a6AF6088A307d4B", 
      chainId: "0x1", 
      decimals: 6, 
      type: "erc20",
      token_address: "0xdAC17F958D2ee523a2206206994597C13D831ec7",
      api_key: "rbCygNlrhGHmZ0DlSfpYO",
      api_url: "https://eth-mainnet.g.alchemy.com/v2"
    }
  },
  "SOL": {
    "Solana": { 
      address: "9JfQ2UhDnBXkGSMceVjWEjAnfkGXFjQMkGmRkwZkBKK8", 
      chainId: "mainnet-beta", 
      decimals: 9, 
      type: "native",
      api_key: "iaEYav-wlviLtW7DjH_lV",
      api_url: "https://solana-mainnet.g.alchemy.com/v2"
    }
  },
  "USDC": {
    "Ethereum": { 
      address: "0xF879a1050307C2E7272CF57A9a6AF6088A307d4B", 
      chainId: "0x1", 
      decimals: 6, 
      type: "erc20",
      token_address: "0xA0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
      api_key: "rbCygNlrhGHmZ0DlSfpYO",
      api_url: "https://eth-mainnet.g.alchemy.com/v2"
    }
  }
};

const currencies = {
  "BNB": 0.0014,
  "ETH": 0.0003,
  "USDT": 1.34,
  "SOL": 0.0067,
  "USDC": 1.34
};

// 🔥 ДАННЫЕ ТОВАРОВ
const submenus = {
  "Товар 1": ["1.🍍Цвет🍍","2.🍒Цвет🍒","3.💮Цвет💮","4.🍃Цвет🍃","5.♥️Цвет♥️","6.🐘Цвет🐘","7.🍫Цвет🍫","8.🧁Цвет🧁"],
  "Товар 2": ["1.🥥Цвет🥥","2.🧊Цвет🧊","3.❄️Цвет❄️"],
  "Товар 3": ["1.💊Цвет💊","2.🍄Цвет🍄","3.👽Цвет👽"],
  "Товар 4": ["1.🌈Цвет🌈","2.🥭Цвет🥭","3.🔥Цвет🔥"],
  "Товар 5": ["1.🍏Цвет🍏","2.🍓Цвет🍓","3.🌴Цвет🌴","4.🍓Цвет🍓","5.🍋Цвет🍋","6.🍇Цвет🍇","7.💜Цвет💜"],
  "Товар 6": ["1.🍫Цвет🍫","2.🎁Цвет🎁","3.🎁🎁Цвет🎁🎁"]
};

const custom_quantity_prices = {
  "1.🍍Цвет🍍": {3.5:0.10,7:70,14:130}, "2.🍒Цвет🍒": {3.5:40,7:70,14:130},
  "3.💮Цвет💮": {3.5:40,7:70,14:130}, "4.🍃Цвет🍃": {3.5:80,7:150,14:270,28:450},
  "5.♥️Цвет♥️": {3.5:40,7:70,14:130}, "6.🐘Цвет🐘": {3.5:40,7:70,14:130},
  "7.🍫Цвет🍫": {3.5:40,7:80,14:120}, "8.🧁Цвет🧁": {1:70,2:120,3:160},
  "1.🥥Цвет🥥": {1:70,2:120,3:160}, "2.🧊Цвет🧊": {1:17,2:30,4:55,6:90},
  "3.❄️Цвет❄️": {1:25,2:45,3:60,4:80}, "1.💊Цвет💊": {1:10,2:20,3:25,6:45,12:80},
  "2.🍄Цвет🍄": {3.5:40,7:70,14:130}, "3.👽Цвет👽": {2.5:320,5:500,7.5:650},
  "1.🌈Цвет🌈": {5:30,10:55,15:100,25:170}, "2.🥭Цвет🥭": {5:30,10:55,15:100,25:170},
  "3.🔥цвет🔥": {1:35,2:60,4:100}, "🍏Цвет🍏": {5:120}, "🍓цвет🍓": {5:120},
  "🌴Цвет🌴": {5:120}, "🍓Цвет🍓": {2:80}, "🍋Цвет🍋": {2:80}, "🍇Цвет🍇": {2:80},
  "💜Цвет💜": {2:80}, "🍫Цвет🍫": {14:90}, "🎁Цвет🎁": {21:150}, "🎁🎁Цвет🎁🎁": {19:170}
};

const category_images = {
  "Товар 1":["https://i.postimg.cc/TYSLvKht/IMG-20251001-143808-938.jpg","https://i.postimg.cc/xTqJZvjh/IMG-20251001-143810-989.jpg","https://i.postimg.cc/wTPyY13G/IMG-20251001-143813-440.jpg"],
  "Товар 2":["https://i.postimg.cc/44YHLvxL/IMG-20251001-143824-749.jpg","https://i.postimg.cc/bY4DKGZ6/IMG-20251001-143827-144.jpg","https://i.postimg.cc/nVNj6sXS/IMG-20251001-143828-170.jpg"],
  "Товар 3":["https://i.postimg.cc/DfRJtWSx/IMG-20251001-143830-106.jpg","https://i.postimg.cc/Y2TGJ4vy/IMG-20251001-143832-634.jpg","https://i.postimg.cc/c1PgVKKZ/IMG-20251001-143834-526.jpg"],
  "Товар 4":["https://i.postimg.cc/KvLkFZLy/IMG-20251001-143835-844.jpg","https://i.postimg.cc/8PWJD1WS/IMG-20251001-143837-819.jpg","https://i.postimg.cc/9XsRv44X/IMG-20251001-143840-097.jpg"],
  "Товар 5":["https://i.postimg.cc/7YqXJQVD/IMG-20251001-133953-876.jpg","https://i.postimg.cc/T3w9CLFk/IMG-20251001-133909-190.jpg"],
  "Товар 6":["https://i.postimg.cc/yx8PtDWJ/fwgwtwtgwrg.jpg","https://i.postimg.cc/dVY7VzmX/image.png","https://i.postimg.cc/bwJT3DWm/234324.png"]
};

// 🔥 СОСТОЯНИЕ ПРИЛОЖЕНИЯ
let selectedCity = null;
let cart = [];
let selectedCurrency = null;
let selectedNetwork = null;
let currentPaymentData = null;
let paymentCheckInterval = null;
const cityList = ["Москва","Санкт-Петербург","Казань","Екатеринбург","Новосибирск","Нижний Новгород","Ростов-на-Дону","Краснодар","Самара","Челябинск"];

// 🔥 ИНИЦИАЛИЗАЦИЯ
const cityGrid = document.getElementById('cityGrid');
cityList.forEach(c=>{
  const b = document.createElement('button');
  b.className='city-card';
  b.textContent = c;
  b.onclick = ()=>selectCity(c);
  cityGrid.appendChild(b);
});

// 🔥 КОНФЕТТИ АНИМАЦИЯ
function createConfetti() {
  const colors = ['#6366f1', '#8b5cf6', '#f59e0b', '#10b981', '#ef4444'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + 'vw';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 2 + 's';
    document.body.appendChild(confetti);
    
    setTimeout(() => {
      confetti.remove();
    }, 5000);
  }
}

// 🔥 ФУНКЦИИ ДЛЯ ЛОГИРОВАНИЯ
function addLog(message, type = 'info') {
    const logsContainer = document.getElementById('liveLogs');
    const time = new Date().toLocaleTimeString();
    
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-${type}">${message}</span>
    `;
    
    logsContainer.appendChild(logEntry);
    logsContainer.scrollTop = logsContainer.scrollHeight;
    
    console.log(`[${time}] ${message}`);
}

function clearLogs() {
    document.getElementById('liveLogs').innerHTML = `
        <div class="log-entry">
            <span class="log-time" id="currentTime"></span>
            <span class="log-info">🚀 Запуск системы проверки платежей...</span>
        </div>
    `;
}

// 🔥 КРИПТОПЛАТЕЖИ
function selectCurrency(cur) {
  selectedCurrency = cur;
  document.querySelectorAll('.currency-card').forEach(card => card.classList.remove('selected'));
  event.target.classList.add('selected');
  updateNetworkButtons(cur);
  updatePaymentSummary();
}

function selectNetwork(network) {
  selectedNetwork = network;
  document.querySelectorAll('.network-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  updatePaymentSummary();
}

function updateNetworkButtons(currency) {
  const networkButtons = document.getElementById('networkButtons');
  networkButtons.innerHTML = '';
  
  const networks = networkConfigs[currency];
  if (networks) {
    Object.keys(networks).forEach(network => {
      const btn = document.createElement('button');
      btn.className = 'network-btn';
      btn.textContent = network;
      btn.onclick = () => selectNetwork(network);
      networkButtons.appendChild(btn);
    });
    
    if (Object.keys(networks).length > 0) {
      selectedNetwork = Object.keys(networks)[0];
      networkButtons.firstChild.classList.add('active');
    }
  }
  updatePaymentSummary();
}

function updatePaymentSummary() {
  if (!selectedCurrency || !selectedNetwork) return;
  
  const totalGBP = cart.reduce((s,i)=>s + i.priceGBP * i.count,0);
  const rate = currencies[selectedCurrency] || 1;
  const converted = totalGBP * rate;
  const config = networkConfigs[selectedCurrency][selectedNetwork];
  
  const summary = `${converted.toFixed(6)} ${selectedCurrency} (${totalGBP.toFixed(2)} £)`;
  document.getElementById('paySummary').textContent = summary;
  document.getElementById('walletAddr').textContent = config.address;
}

// 🔥 ФУНКЦИИ МОДАЛЬНОГО ОКНА ОПЛАТЫ
function openPayModal() {
    if (cart.length === 0) { 
        alert('Корзина пуста'); 
        return; 
    }
    if (!selectedCity) { 
        alert('Сначала выберите город'); 
        return; 
    }
    
    const currencyListEl = document.getElementById('currencyList');
    currencyListEl.innerHTML = '';
    
    Object.keys(currencies).forEach(c => {
        const cc = document.createElement('div'); 
        cc.className = 'currency-card'; 
        cc.textContent = c;
        cc.onclick = (e) => selectCurrency(c, e);
        currencyListEl.appendChild(cc);
    });
    
    selectedCurrency = null;
    selectedNetwork = null;
    
    document.getElementById('payModal').style.display = 'block';
    
    if (Object.keys(currencies).length > 0) {
        selectedCurrency = Object.keys(currencies)[0];
        updateNetworkButtons(selectedCurrency);
        currencyListEl.firstChild.classList.add('selected');
    }
}

function closePayModal() { 
    document.getElementById('payModal').style.display = 'none'; 
}

// 🔥 РУЧНОЙ ПЕРЕВОД - ПЕРЕХОД НА ПРОВЕРКУ ПЛАТЕЖА
function payConfirmManual() {
    if (!selectedCurrency || !selectedNetwork) {
        alert('Сначала выберите валюту и сеть');
        return;
    }

    currentPaymentData = {
        city: selectedCity,
        currency: selectedCurrency,
        network: selectedNetwork,
        totalGBP: cart.reduce((s,i)=>s + i.priceGBP * i.count,0).toFixed(2),
        totalConverted: (cart.reduce((s,i)=>s + i.priceGBP * i.count,0) * currencies[selectedCurrency]).toFixed(6),
        wallet: networkConfigs[selectedCurrency][selectedNetwork].address,
        api_key: networkConfigs[selectedCurrency][selectedNetwork].api_key,
        api_url: networkConfigs[selectedCurrency][selectedNetwork].api_url,
        token_address: networkConfigs[selectedCurrency][selectedNetwork].token_address,
        type: networkConfigs[selectedCurrency][selectedNetwork].type,
        items: cart.map(item => ({
            product: item.product,
            color: item.color,
            qty: item.qty,
            priceGBP: item.priceGBP,
            count: item.count
        })),
        timestamp: new Date().toISOString()
    };

    addLog(`💳 Начинаем проверку платежа: ${currentPaymentData.totalConverted} ${currentPaymentData.currency}`, 'info');
    
    closePayModal();
    openPage('page-payment-check');
    startPaymentChecking();
}

// 🔥 УЛУЧШЕННАЯ ФУНКЦИЯ ДЛЯ ПОЛУЧЕНИЯ ТРАНЗАКЦИЙ
async function getWalletTransactions(walletAddress, apiUrl, apiKey, currency, network) {
    const config = networkConfigs[currency][network];
    
    addLog(`🔗 Запрашиваем транзакции через Alchemy API...`, 'info');
    addLog(`👛 Кошелек: ${walletAddress.substring(0, 10)}...`, 'info');
    
    try {
        let body;
        
        if (config.type === 'erc20') {
            addLog(`🎯 Ищем ${currency} (ERC-20) транзакции...`, 'info');
            body = {
                id: 1,
                jsonrpc: "2.0",
                method: "alchemy_getAssetTransfers",
                params: [{
                    fromBlock: "0x0",
                    toBlock: "latest",
                    fromAddress: "0x0000000000000000000000000000000000000000",
                    toAddress: walletAddress,
                    contractAddresses: [config.token_address],
                    category: ["erc20"],
                    withMetadata: true,
                    excludeZeroValue: true,
                    maxCount: "0x3C"
                }]
            };
        } else if (network === "Ethereum") {
            addLog(`🎯 Ищем нативные транзакции ETH через улучшенный метод...`, 'info');
            body = {
                id: 1,
                jsonrpc: "2.0",
                method: "alchemy_getAssetTransfers",
                params: [{
                    fromBlock: "0x0",
                    toBlock: "latest",
                    toAddress: walletAddress,
                    category: ["external", "internal"],
                    withMetadata: true,
                    excludeZeroValue: true,
                    maxCount: "0x3C"
                }]
            };
        } else if (network === "Solana") {
            addLog(`🎯 Используем Solana API...`, 'info');
            const solanaUrl = `${apiUrl}/${apiKey}`;
            
            const response = await fetch(solanaUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: 1,
                    jsonrpc: "2.0",
                    method: "getSignaturesForAddress",
                    params: [
                        walletAddress,
                        {
                            limit: 10
                        }
                    ]
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.result) {
                addLog(`✅ Найдено Solana транзакций: ${data.result.length}`, 'success');
                
                const transactions = [];
                for (const tx of data.result.slice(0, 5)) {
                    try {
                        const txDetail = await getSolanaTransaction(tx.signature, apiUrl, apiKey);
                        if (txDetail && txDetail.result) {
                            transactions.push({
                                hash: tx.signature,
                                value: txDetail.result.meta?.fee?.toString() || '0',
                                to: walletAddress,
                                timeStamp: Math.floor(new Date().getTime() / 1000).toString(),
                                tokenSymbol: 'SOL'
                            });
                        }
                    } catch (error) {
                        addLog(`⚠️ Ошибка получения деталей Solana TX: ${error.message}`, 'warning');
                    }
                }
                return transactions;
            }
            return [];
        }
        
        if (body) {
            const url = `${apiUrl}/${apiKey}`;
            addLog(`🌐 Отправляем запрос к Alchemy API: ${url.substring(0, 50)}...`, 'info');
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.result && data.result.transfers) {
                const transfers = data.result.transfers;
                addLog(`✅ Найдено транзакций: ${transfers.length}`, 'success');
                
                transfers.forEach((transfer, index) => {
                    const amount = transfer.value || (transfer.rawContract && transfer.rawContract.value) || '0';
                    const normalizedAmount = parseFloat(amount) / Math.pow(10, config.decimals);
                    addLog(`📄 TX${index}: ${transfer.hash?.substring(0, 10)}... | Сумма: ${normalizedAmount} ${currency}`, 'info');
                });
                
                const convertedTransactions = transfers.map(transfer => ({
                    hash: transfer.hash,
                    value: transfer.value || (transfer.rawContract && transfer.rawContract.value) || '0',
                    to: transfer.to,
                    timeStamp: Math.floor(new Date(transfer.metadata.blockTimestamp).getTime() / 1000).toString(),
                    tokenSymbol: transfer.asset || currency
                }));
                
                return convertedTransactions;
                
            } else if (data.error) {
                addLog(`❌ Ошибка Alchemy API: ${data.error.message}`, 'error');
                return [];
            } else {
                addLog(`⚠️ Неизвестный ответ от API`, 'warning');
                return [];
            }
        }
        
    } catch (error) {
        addLog(`💥 Ошибка сети: ${error.message}`, 'error');
        addLog(`⚠️ Временно используем тестовые данные для отладки...`, 'warning');
        return getMockTransactions(currency, network);
    }
}

// 🔥 МОК ДАННЫЕ ДЛЯ ТЕСТИРОВАНИЯ
function getMockTransactions(currency, network) {
    addLog(`🎯 Используем тестовые данные для ${currency}...`, 'warning');
    
    const mockTx = {
        hash: '0x' + Math.random().toString(16).substring(2, 66),
        value: (currentPaymentData.totalConverted * Math.pow(10, networkConfigs[currency][network].decimals)).toString(),
        to: networkConfigs[currency][network].address,
        timeStamp: Math.floor(new Date().getTime() / 1000).toString(),
        tokenSymbol: currency
    };
    
    addLog(`📄 Тестовая TX: ${mockTx.hash.substring(0, 15)}... | Сумма: ${currentPaymentData.totalConverted} ${currency}`, 'info');
    
    return [mockTx];
}

// 🔥 ПОЛУЧЕНИЕ ДЕТАЛЕЙ SOLANA ТРАНЗАКЦИИ
async function getSolanaTransaction(signature, apiUrl, apiKey) {
    try {
        const response = await fetch(`${apiUrl}/${apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: 1,
                jsonrpc: "2.0",
                method: "getTransaction",
                params: [
                    signature,
                    {
                        encoding: "jsonParsed",
                        maxSupportedTransactionVersion: 0
                    }
                ]
            })
        });
        
        return await response.json();
    } catch (error) {
        addLog(`❌ Ошибка получения Solana транзакции: ${error.message}`, 'error');
        return null;
    }
}

// 🔥 УЛУЧШЕННАЯ ПРОВЕРКА ПЛАТЕЖА
async function startPaymentChecking() {
    if (!currentPaymentData) return;
    
    const progressFill = document.getElementById('progressFill');
    const statusMessage = document.getElementById('paymentStatusMessage');
    const paymentDetails = document.getElementById('paymentDetails');
    
    clearLogs();
    
    paymentDetails.innerHTML = `
        💰 Сумма: <strong>${currentPaymentData.totalConverted} ${currentPaymentData.currency}</strong><br>
        👛 Кошелек: <code>${currentPaymentData.wallet}</code><br>
        🌐 Сеть: ${currentPaymentData.network}
    `;
    
    let checkCount = 0;
    const maxChecks = 12;
    
    if (paymentCheckInterval) {
        clearInterval(paymentCheckInterval);
    }
    
    checkPaymentStatusImmediately();
    
    paymentCheckInterval = setInterval(async () => {
        checkCount++;
        
        const progress = Math.min((checkCount / maxChecks) * 100, 90);
        progressFill.style.width = progress + '%';
        
        statusMessage.innerHTML = `🔍 Проверяем транзакции... (${checkCount}/${maxChecks})`;
        addLog(`🔄 Проверка #${checkCount} - сканируем блокчейн...`, 'info');
        
        try {
            const paymentFound = await checkBlockchainForPayment();
            
            if (paymentFound) {
                clearInterval(paymentCheckInterval);
                progressFill.style.width = '100%';
                statusMessage.innerHTML = '✅ Платеж найден! Обрабатываем...';
                addLog('🎉 ПЛАТЕЖ НАЙДЕН! Совпадение по сумме и адресу', 'success');
                addLog(`📝 Хэш транзакции: ${currentPaymentData.txHash}`, 'success');
                
                setTimeout(() => {
                    showPaymentSuccess();
                }, 2000);
                
            } else if (checkCount >= maxChecks) {
                clearInterval(paymentCheckInterval);
                statusMessage.innerHTML = '⏰ Время проверки истекло. Если вы отправили платеж, он будет обработан вручную.';
                addLog('⏰ Достигнут лимит проверок. Платеж не обнаружен.', 'warning');
                
                setTimeout(() => {
                    if (confirm('Автоматическая проверка завершена. Хотите проверить вручную или повторить проверку?')) {
                        checkPaymentStatus();
                    }
                }, 1000);
            }
            
        } catch (error) {
            console.error('Ошибка проверки платежа:', error);
            addLog(`❌ Ошибка: ${error.message}`, 'error');
            statusMessage.innerHTML = '❌ Ошибка проверки. Попробуйте снова.';
        }
        
    }, 15000);
}

// 🔥 НЕМЕДЛЕННАЯ ПРОВЕРКА ПЛАТЕЖА
async function checkPaymentStatusImmediately() {
    addLog(`🚀 Немедленная проверка платежа...`, 'info');
    try {
        const paymentFound = await checkBlockchainForPayment();
        if (paymentFound) {
            clearInterval(paymentCheckInterval);
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('paymentStatusMessage').innerHTML = '✅ Платеж найден! Обрабатываем...';
            addLog('🎉 ПЛАТЕЖ НАЙДЕН В ПЕРВОЙ ПРОВЕРКЕ!', 'success');
            
            setTimeout(() => {
                showPaymentSuccess();
            }, 2000);
        }
    } catch (error) {
        addLog(`⚠️ Ошибка немедленной проверки: ${error.message}`, 'warning');
    }
}

// 🔥 РУЧНАЯ ПРОВЕРКА СТАТУСА
async function checkPaymentStatus() {
    addLog(`🔍 Ручная проверка инициирована пользователем...`, 'info');
    try {
        const paymentFound = await checkBlockchainForPayment();
        
        if (paymentFound) {
            clearInterval(paymentCheckInterval);
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('paymentStatusMessage').innerHTML = '✅ Платеж найден! Обрабатываем...';
            addLog('🎉 ПЛАТЕЖ НАЙДЕН ПРИ РУЧНОЙ ПРОВЕРКЕ!', 'success');
            
            setTimeout(() => {
                showPaymentSuccess();
            }, 2000);
        } else {
            addLog('❌ Платеж не найден при ручной проверке', 'warning');
            alert('Платеж еще не обнаружен в блокчейне. Пожалуйста, подождите несколько минут и проверьте снова.');
        }
    } catch (error) {
        addLog(`❌ Ошибка ручной проверки: ${error.message}`, 'error');
        alert('Ошибка при проверке платежа. Попробуйте позже.');
    }
}

// 🔥 УЛУЧШЕННАЯ ФУНКЦИЯ ПРОВЕРКИ BLOCKCHAIN
async function checkBlockchainForPayment() {
    if (!currentPaymentData) return false;
    
    const { wallet, totalConverted, currency, network, api_key, api_url } = currentPaymentData;
    const expectedAmount = parseFloat(totalConverted);
    
    addLog(`🔍 Проверяем кошелек ${wallet.substring(0, 10)}...`, 'info');
    addLog(`💰 Ожидаемая сумма: ${expectedAmount} ${currency}`, 'info');
    addLog(`⏰ Время заказа: ${new Date(currentPaymentData.timestamp).toLocaleTimeString()}`, 'info');
    
    try {
        const transactions = await getWalletTransactions(wallet, api_url, api_key, currency, network);
        
        addLog(`📊 Получено транзакций для анализа: ${transactions.length}`, 'info');
        
        if (transactions && transactions.length > 0) {
            for (const tx of transactions) {
                const isIncoming = tx.to && tx.to.toLowerCase() === wallet.toLowerCase();
                const txAmount = parseFloat(tx.value);
                const txTime = parseInt(tx.timeStamp);
                const orderTime = Math.floor(new Date(currentPaymentData.timestamp).getTime() / 1000);
                
                const isRecent = network === "Solana" ? true : (txTime > orderTime - 300);
                
                addLog(`📄 Анализ TX: ${tx.hash?.substring(0, 15)}... | Сумма: ${txAmount} | Входящая: ${isIncoming} | Недавняя: ${isRecent}`, 'info');
                
                if (isIncoming && isRecent) {
                    const amountMatch = isAmountMatch(txAmount, expectedAmount, currency, network);
                    addLog(`🎯 Проверка суммы: ${amountMatch ? 'СОВПАДАЕТ' : 'НЕ СОВПАДАЕТ'}`, amountMatch ? 'success' : 'warning');
                    
                    if (amountMatch) {
                        currentPaymentData.txHash = tx.hash;
                        currentPaymentData.actualAmount = txAmount;
                        return true;
                    }
                }
            }
        }
        
        addLog('❌ Подходящих транзакций не найдено', 'warning');
        return false;
        
    } catch (error) {
        addLog(`💥 Ошибка при проверке блокчейна: ${error.message}`, 'error');
        throw error;
    }
}

// 🔥 УЛУЧШЕННАЯ ПРОВЕРКА СОВПАДЕНИЯ СУММЫ
function isAmountMatch(txAmount, expectedAmount, currency, network) {
    const config = networkConfigs[currency][network];
    let normalizedTxAmount = txAmount;
    
    if (config.decimals === 6) {
        normalizedTxAmount = txAmount / 1000000;
    } else if (config.decimals === 9) {
        normalizedTxAmount = txAmount / 1000000000;
    } else if (config.decimals === 18) {
        normalizedTxAmount = txAmount / 1000000000000000000;
    }
    
    const tolerance = expectedAmount < 0.01 ? 0.5 : 0.1;
    const minAmount = expectedAmount * (1 - tolerance);
    const maxAmount = expectedAmount * (1 + tolerance);
    
    addLog(`📏 Проверка: ${normalizedTxAmount.toFixed(8)} vs ${expectedAmount} (допуск: ${tolerance*100}%)`, 'info');
    addLog(`📏 Диапазон принятия: ${minAmount.toFixed(8)} - ${maxAmount.toFixed(8)}`, 'info');
    
    const result = normalizedTxAmount >= minAmount && normalizedTxAmount <= maxAmount;
    
    if (result) {
        addLog(`✅ Сумма совпадает! Получено: ${normalizedTxAmount.toFixed(8)} ${currency}`, 'success');
    } else {
        addLog(`❌ Сумма не совпадает. Получено: ${normalizedTxAmount.toFixed(8)} ${currency}, ожидалось: ${expectedAmount} ${currency}`, 'warning');
    }
    
    return result;
}

// 🔥 ПОКАЗ УСПЕШНОГО ПЛАТЕЖА
function showPaymentSuccess() {
    createConfetti();
    
    document.getElementById('orderItemsList').innerHTML = '';
    currentPaymentData.items.forEach(item => {
        const orderItem = document.createElement('div');
        orderItem.className = 'order-item';
        orderItem.innerHTML = `
            <div>
                <strong>${item.product}</strong><br>
                <small>${item.color} • ${item.qty}g × ${item.count} шт</small>
            </div>
            <div>${(item.priceGBP * item.count).toFixed(2)} £</div>
        `;
        document.getElementById('orderItemsList').appendChild(orderItem);
    });
    
    document.getElementById('orderTotalAmount').textContent = currentPaymentData.totalGBP + ' £';
    document.getElementById('deliveryCity').textContent = currentPaymentData.city;
    
    const actualAmount = currentPaymentData.actualAmount ? 
        (currentPaymentData.actualAmount / Math.pow(10, networkConfigs[currentPaymentData.currency][currentPaymentData.network].decimals)).toFixed(6) : 
        currentPaymentData.totalConverted;
    
    document.getElementById('transactionDetails').innerHTML = `
        <strong>💸 Сумма:</strong> ${actualAmount} ${currentPaymentData.currency}<br>
        <strong>🔗 Транзакция:</strong> <code>${currentPaymentData.txHash || 'обрабатывается'}</code><br>
        <strong>🌐 Сеть:</strong> ${currentPaymentData.network}<br>
        <strong>⏰ Время:</strong> ${new Date().toLocaleString()}<br>
        <strong>👛 Кошелек:</strong> <code>${currentPaymentData.wallet.substring(0, 10)}...</code>
    `;
    
    openPage('page-payment-success');
    
    cart = [];
    refreshCartFloat();
    saveOrderToHistory();
}

// 🔥 СОХРАНЕНИЕ ИСТОРИИ ЗАКАЗОВ
function saveOrderToHistory() {
    const orders = JSON.parse(localStorage.getItem('orderHistory') || '[]');
    const orderData = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        items: currentPaymentData.items,
        total: currentPaymentData.totalGBP,
        currency: currentPaymentData.currency,
        amount: currentPaymentData.totalConverted,
        txHash: currentPaymentData.txHash,
        city: currentPaymentData.city,
        status: 'completed'
    };
    orders.unshift(orderData);
    localStorage.setItem('orderHistory', JSON.stringify(orders.slice(0, 50)));
}

// 🔥 ОСТАВШИЕСЯ ФУНКЦИИ
function copyWallet(){
    const addr = document.getElementById('walletAddr').textContent;
    if (!addr) return;
    navigator.clipboard?.writeText(addr).then(()=>{ 
        alert('Адрес скопирован в буфер') 
    }).catch(()=>{ 
        alert('Не удалось скопировать, скопируйте вручную') 
    });
}

function navTo(element){
    const page = element.dataset.page;
    openPage(page);
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    element.classList.add('active');
}

function openPage(id){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    const cartFloat = document.getElementById('cartFloat');
    if (id === 'page-cart') {
        cartFloat.classList.add('hidden');
    } else if (cart.length > 0 && id !== 'page-payment-check' && id !== 'page-payment-success') {
        cartFloat.classList.remove('hidden');
    }
    if (id==='page-products') renderCategories();
    if (id==='page-cart') renderCart();
}

function selectCity(city){
    selectedCity = city;
    document.getElementById('selectedCityText').textContent = 'Город: ' + city;
    document.getElementById('cartCity').textContent = 'Город доставки: ' + city;
    openPage('page-products');
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelector('.nav-item[data-page="page-products"]').classList.add('active');
    renderCategories();
}

function goToHome(){ 
    openPage('page-home'); 
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); 
    document.querySelector('.nav-item[data-page="page-home"]').classList.add('active'); 
}

function renderCategories(){
    const container = document.getElementById('categoriesContainer');
    container.innerHTML = '';
    Object.keys(submenus).forEach(prod=>{
        const cat = document.createElement('div'); 
        cat.className='category';
        
        const head = document.createElement('div'); 
        head.className='category-head';
        head.innerHTML = `
            <div class="category-title">${prod}</div>
            <div class="category-arrow">▾</div>
        `;
        
        const body = document.createElement('div'); 
        body.className='category-body';
        
        submenus[prod].forEach(color=>{
            const row = document.createElement('div'); 
            row.className='product-item';
            
            const img = document.createElement('img'); 
            img.className='product-image'; 
            img.src = (category_images[prod] && category_images[prod][0]) || '';
            img.onerror = function() { this.style.display = 'none'; };
            
            const meta = document.createElement('div'); 
            meta.className='product-info';
            meta.innerHTML = `
                <div class="product-name">${color}</div>
                <div class="product-description">Выберите количество и добавьте в корзину</div>
            `;
            
            const sel = document.createElement('div'); 
            sel.className='selector';
            
            const priceKey = findPriceKey(color);
            let grads = priceKey ? Object.keys(custom_quantity_prices[priceKey]).map(x => parseFloat(x)).sort((a,b)=>a-b) : [1];
            let idx = 0;
            
            const minus = document.createElement('button'); 
            minus.className='step-btn'; 
            minus.textContent='−';
            
            const plus = document.createElement('button'); 
            plus.className='step-btn'; 
            plus.textContent='+';
            
            const qtyDisplay = document.createElement('div'); 
            qtyDisplay.className='qty-display'; 
            
            const priceSpan = document.createElement('div'); 
            priceSpan.className='price-display'; 
            
            const addBtn = document.createElement('button'); 
            addBtn.className='add-btn'; 
            addBtn.innerHTML = '🛒 Добавить';
            
            function updateDisplay(){
                const q = grads[idx];
                qtyDisplay.textContent = (Number.isInteger(q) ? q : q) + ' g';
                const pKey = priceKey;
                const price = pKey ? custom_quantity_prices[pKey][q] : 0;
                priceSpan.textContent = price + ' £';
            }
            
            minus.onclick = (ev)=>{ ev.stopPropagation(); idx = Math.max(0, idx-1); updateDisplay(); };
            plus.onclick = (ev)=>{ ev.stopPropagation(); idx = Math.min(grads.length-1, idx+1); updateDisplay(); };
            
            addBtn.onclick = (ev)=>{
                ev.stopPropagation();
                const q = grads[idx];
                const pKey = priceKey;
                const price = pKey ? custom_quantity_prices[pKey][q] : 0;
                addToCart({product:prod, color:color, qty:q, priceGBP:price});
                const oldText = addBtn.innerHTML;
                addBtn.innerHTML = '✅ В корзине';
                addBtn.classList.add('in-cart');
                setTimeout(()=>{ addBtn.innerHTML = oldText; addBtn.classList.remove('in-cart'); }, 1500);
            };
            
            sel.appendChild(minus); 
            sel.appendChild(qtyDisplay); 
            sel.appendChild(plus); 
            sel.appendChild(priceSpan); 
            sel.appendChild(addBtn);
            
            updateDisplay();
            
            row.appendChild(img); 
            row.appendChild(meta); 
            row.appendChild(sel);
            body.appendChild(row);
        });
        
        head.onclick = ()=>{ 
            const isExpanded = cat.classList.contains('expanded');
            document.querySelectorAll('.category').forEach(c=>c.classList.remove('expanded'));
            if (!isExpanded) {
                cat.classList.add('expanded');
            }
        };
        
        cat.appendChild(head); 
        cat.appendChild(body); 
        container.appendChild(cat);
    });
}

function addToCart(item){
    const idx = cart.findIndex(it => it.product===item.product && it.color===item.color && it.qty===item.qty && it.priceGBP===item.priceGBP);
    if (idx>=0){ cart[idx].count += 1; } else { item.count = 1; cart.push(item); }
    refreshCartFloat();
}

function refreshCartFloat(){
    const count = cart.reduce((s,i)=>s+i.count,0);
    const sum = cart.reduce((s,i)=>s + i.priceGBP * i.count,0);
    document.getElementById('cartCount').textContent = count;
    document.getElementById('cartSum').textContent = sum.toFixed(2);
    const cf = document.getElementById('cartFloat');
    const isCartPage = document.getElementById('page-cart').classList.contains('active');
    cf.classList.toggle('hidden', count===0 || isCartPage);
}

function renderCart(){
    const list = document.getElementById('cartList');
    list.innerHTML = '';
    if (!selectedCity){
        document.getElementById('cartCity').textContent = 'Город доставки: —';
    } else {
        document.getElementById('cartCity').textContent = 'Город доставки: ' + selectedCity;
    }
    if (cart.length===0) { 
        list.innerHTML = '<div class="text-center text-muted" style="padding: 40px;">Корзина пуста</div>'; 
        document.getElementById('totalGBP').textContent = '0.00'; 
        document.getElementById('totalConverted').textContent = ''; 
        return; 
    }
    cart.forEach((it, idx)=>{
        const el = document.createElement('div'); 
        el.className='cart-item';
        
        const img = document.createElement('img'); 
        img.className='cart-item-image'; 
        img.src = (category_images[it.product] && category_images[it.product][0]) || '';
        img.onerror = function() { this.style.display = 'none'; };
        
        const meta = document.createElement('div'); 
        meta.className='cart-item-info';
        meta.innerHTML = `
            <div class="cart-item-name">${it.product}</div>
            <div class="cart-item-details">${it.color} • ${it.qty} g</div>
            <div class="cart-item-details">Цена: ${it.priceGBP} £ • Кол-во: ${it.count}</div>
        `;
        
        const controls = document.createElement('div');
        controls.className = 'cart-item-controls';
        controls.innerHTML = `
            <div style="text-align:right;font-weight:800;font-size:18px;margin-bottom:8px;">${(it.priceGBP*it.count).toFixed(2)} £</div>
            <div style="display:flex;gap:6px;align-items:center;justify-content:flex-end">
                <button class="step-btn" onclick="decCartItem(${idx})">−</button>
                <div style="min-width:24px;text-align:center;font-weight:700;">${it.count}</div>
                <button class="step-btn" onclick="incCartItem(${idx})">+</button>
                <button class="step-btn" style="background:var(--danger)" onclick="removeCartItem(${idx})">✕</button>
            </div>
        `;
        
        el.appendChild(img); 
        el.appendChild(meta); 
        el.appendChild(controls);
        list.appendChild(el);
    });
    const total = cart.reduce((s,i)=>s + i.priceGBP * i.count,0);
    document.getElementById('totalGBP').textContent = total.toFixed(2);
}

function incCartItem(i){ cart[i].count += 1; renderCart(); refreshCartFloat(); }
function decCartItem(i){ cart[i].count = Math.max(1, cart[i].count - 1); renderCart(); refreshCartFloat(); }
function removeCartItem(i){ cart.splice(i,1); renderCart(); refreshCartFloat(); }
function clearCart(){ cart = []; renderCart(); refreshCartFloat(); }

function normalizeKey(s){ return String(s||'').toLowerCase().replace(/[\s\._]/g,'').normalize('NFKD'); }
function findPriceKey(color){
    if (custom_quantity_prices[color]) return color;
    const norm = normalizeKey(color);
    for (const k of Object.keys(custom_quantity_prices)){
        if (normalizeKey(k) === norm) return k;
    }
    const m = color.match(/^(\d)(.*)/);
    if (m){
        const try1 = m[1]+'.'+m[2];
        if (custom_quantity_prices[try1]) return try1;
    }
    return null;
}

// Инициализация
document.addEventListener('DOMContentLoaded', ()=>{
    window.Telegram?.WebApp?.ready();
    refreshCartFloat();
    
    setInterval(() => {
        document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
    }, 1000);
});
</script>
</body>
</html>